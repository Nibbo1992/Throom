<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>D&D Session Notes</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
Â  <style>
Â  Â  body {
Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  transition: background-color 0.4s, color 0.4s;
Â  Â  }
Â  Â  /* INCREASED NOTES AREA HEIGHT by reducing the fixed offset from 300px to 250px */
Â  Â  #notes-area, #preview {
Â  Â  Â  height: calc(100vh - 250px);
Â  Â  Â  overflow-y: auto; /* Enable scrolling for long content */
Â  Â  Â  resize: none;
Â  Â  }
Â  Â  .text-sm { font-size: 0.875rem; }
Â  Â  .text-base { font-size: 1rem; }
Â  Â  /* Dark Mode Styles */
Â  Â  .dark-mode {
Â  Â  Â  background-color: #1e1e1e !important;
Â  Â  Â  color: #f1f1f1 !important;
Â  Â  }
Â  Â  .dark-mode textarea,
Â  Â  .dark-mode #preview {
Â  Â  Â  background-color: #2a2a2a !important;
Â  Â  Â  color: #f1f1f1 !important;
Â  Â  Â  border-color: #444 !important;
Â  Â  }
    /* Fix for prose content in dark mode */
    .dark-mode #preview.prose h1, .dark-mode #preview.prose h2, .dark-mode #preview.prose h3 {
        color: #ddd !important;
    }
    .dark-mode #preview.prose {
        color: #f1f1f1;
    }
    /* Style for the index area in preview */
    .index-panel {
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
    }
    .dark-mode .index-panel {
        background-color: #333;
        border-color: #444;
    }
    .dark-mode .index-panel h4 {
        color: #ddd;
    }
    /* Styling for the target tag after jumping */
    .scroll-target {
        scroll-margin-top: 1.5rem; /* Offset for sticky headers if they existed, or just a little padding */
    }
    /* Custom styling for dark mode button group borders to ensure visibility */
    .dark-mode .header-btn {
        border-color: #374151 !important; /* Darker border for separation */
    }
    .dark-mode .toolbar-btn, .dark-mode #heading-select {
        border-color: #3f3f46 !important;
    }
    .dark-mode #clear-btn {
        border-color: #991b1b !important; 
    }
Â  </style>
</head>
<body class="bg-stone-100 text-slate-800">
Â  Â  
Â  <div class="container mx-auto p-4 max-w-5xl">
Â  Â  <!-- REDUCED HEADER MARGIN FROM mb-4 to mb-2 -->
Â  Â  <header class="text-center mb-2">
Â  Â  Â  <h1 class="text-2xl md:text-3xl font-bold mb-0">Session Notes: The Stonebreaker's Journal</h1>
Â  Â  Â  <p id="status-message" class="text-slate-600 dark-mode:text-slate-400 text-xs mb-3">Notes are automatically saved to your browser as you type.</p>
Â  Â  Â  <!-- BUTTON GROUP: Removed gap-[1px], added overflow-hidden, rounded-lg, and shadow-md to container -->
Â  Â  Â  <div class="flex flex-wrap justify-center mb-3 text-white shadow-md rounded-lg overflow-hidden">
Â  Â  Â  Â  <!-- Buttons now use border-r to separate, creating a continuous block effect -->
Â  Â  Â  Â  <button id="save-btn" class="header-btn px-3 py-2 text-sm bg-slate-700 hover:bg-slate-800 border-r border-slate-500/50">ğŸ’¾ <span class="hidden sm:inline">Save</span></button>
Â  Â  Â  Â  <button id="download-btn" class="header-btn px-3 py-2 text-sm bg-slate-700 hover:bg-slate-800 border-r border-slate-500/50">â¬‡ï¸ <span class="hidden sm:inline">Download</span></button>
Â  Â  Â  Â  <button id="timestamp-btn" class="header-btn px-3 py-2 text-sm bg-slate-700 hover:bg-slate-800 border-r border-slate-500/50">ğŸ•’ <span class="hidden sm:inline">Timestamp</span></button>
Â  Â  Â  Â  <!-- Clear button is red and needs its own specific border color for the group effect -->
Â  Â  Â  Â  <button id="clear-btn" class="header-btn px-3 py-2 text-sm bg-red-600 hover:bg-red-700 border-r border-red-500/50">âŒ <span class="hidden sm:inline">Clear</span></button>
Â  Â  Â  Â  <button id="preview-toggle" class="header-btn px-3 py-2 text-sm bg-slate-700 hover:bg-slate-800 border-r border-slate-500/50">ğŸ‘ï¸ <span class="hidden sm:inline">Preview</span></button>
Â  Â  Â  Â  <!-- Dark Mode button is the last in the group, no right border needed -->
Â  Â  Â  Â  <button id="dark-toggle" class="header-btn px-3 py-2 text-sm bg-slate-700 hover:bg-slate-800">ğŸŒ™ <span class="hidden sm:inline">Dark Mode</span></button>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <div class="bg-white p-4 rounded-lg shadow-xl border border-slate-200">
Â  Â  Â  <div id="editor-container">
Â  Â  Â  Â  <!-- TOOLBAR GROUP: Removed gap-[1px], added shadow-sm, rounded, and overflow-hidden -->
Â  Â  Â  Â  <div id="toolbar" class="flex flex-wrap mb-2 shadow-sm rounded overflow-hidden">
Â  Â  Â  Â  Â  <!-- Buttons now use border-r to separate and are slightly larger for better touch targets -->
Â  Â  Â  Â  Â  <button data-format="bold" title="Bold (Ctrl/Cmd+B)" class="toolbar-btn px-2 py-1 text-sm bg-slate-200 hover:bg-slate-300 border-r border-slate-300">B</button>
Â  Â  Â  Â  Â  <button data-format="italic" title="Italic (Ctrl/Cmd+I)" class="toolbar-btn px-2 py-1 text-sm italic bg-slate-200 hover:bg-slate-300 border-r border-slate-300">I</button>
Â  Â  Â  Â  Â  <button data-format="underline" title="Underline" class="toolbar-btn px-2 py-1 text-sm bg-slate-200 hover:bg-slate-300 border-r border-slate-300">U</button>
Â  Â  Â  Â  Â  <button data-format="strike" title="Strikethrough" class="toolbar-btn px-2 py-1 text-sm bg-slate-200 hover:bg-slate-300 border-r border-slate-300">S</button>
Â  Â  Â  Â  Â  <select id="heading-select" class="px-2 py-1 text-sm bg-slate-200 hover:bg-slate-300 border-r border-slate-300 cursor-pointer">
Â  Â  Â  Â  Â  Â  <option value="">Normal</option>
Â  Â  Â  Â  Â  Â  <option value="h1">H1</option>
Â  Â  Â  Â  Â  Â  <option value="h2">H2</option>
Â  Â  Â  Â  Â  Â  <option value="h3">H3</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  <button data-format="list" title="List" class="toolbar-btn px-2 py-1 text-sm bg-slate-200 hover:bg-slate-300 border-r border-slate-300">â€¢</button> 
Â  Â  Â  Â  Â  <button data-format="quote" title="Quote" class="toolbar-btn px-2 py-1 text-sm bg-slate-200 hover:bg-slate-300 border-r border-slate-300">â</button>
Â  Â  Â  Â  Â  <button data-format="code" title="Code Inline" class="toolbar-btn px-2 py-1 text-sm bg-slate-200 hover:bg-slate-300 border-r border-slate-300">{ }</button>
Â  Â  Â  Â  Â  <!-- Divider button is the last in the group -->
Â  Â  Â  Â  Â  <button data-format="divider" title="Divider" class="toolbar-btn px-2 py-1 text-sm bg-slate-200 hover:bg-slate-300">â€•</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <textarea id="notes-area" class="w-full p-4 border border-slate-300 rounded-lg focus:ring-slate-500 focus:border-slate-500 text-slate-700 text-base" placeholder="Start logging your adventure here...\n\n-- Session [Date] --\nKey NPCs: \nLocations: \nEvents:"></textarea>
Â  Â  Â  Â  <div id="preview" class="hidden w-full p-4 border border-slate-300 rounded-lg prose prose-slate max-w-none"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="text-right text-slate-500 text-sm mt-2" id="word-count">0 words</div>
Â  </div>

Â  <script>
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  const notesArea = document.getElementById('notes-area');
Â  Â  Â  const saveBtn = document.getElementById('save-btn');
Â  Â  Â  const downloadBtn = document.getElementById('download-btn');
Â  Â  Â  const clearBtn = document.getElementById('clear-btn');
Â  Â  Â  const timestampBtn = document.getElementById('timestamp-btn');
Â  Â  Â  const previewToggle = document.getElementById('preview-toggle');
Â  Â  Â  const preview = document.getElementById('preview');
Â  Â  Â  const darkToggle = document.getElementById('dark-toggle');
Â  Â  Â  const statusMessage = document.getElementById('status-message');
Â  Â  Â  const toolbarBtns = document.querySelectorAll('.toolbar-btn');
Â  Â  Â  const headingSelect = document.getElementById('heading-select');
Â  Â  Â  const wordCount = document.getElementById('word-count');

Â  Â  Â  const STORAGE_KEY = 'throom_session_notes';
Â  Â  Â  const DARK_KEY = 'throom_dark_mode';

Â  Â  Â  // Configure markdown-it for basic rendering
Â  Â  Â  const md = window.markdownit({ breaks: true, html: true });

Â  Â  Â  // --- Core Functions ---

Â  Â  Â  const saveNotes = () => {
Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, notesArea.value);
Â  Â  Â  Â  statusMessage.textContent = 'ğŸ’¾ Saved!';
Â  Â  Â  Â  setTimeout(() => statusMessage.textContent = 'Notes are automatically saved to your browser as you type.', 1500);
Â  Â  Â  };

Â  Â  Â  const loadNotes = () => {
Â  Â  Â  Â  const saved = localStorage.getItem(STORAGE_KEY);
Â  Â  Â  Â  if (saved) notesArea.value = saved;
Â  Â  Â  Â  updateWordCount();
Â  Â  Â  Â  notesArea.focus(); // Auto-focus on load for seamless start
Â  Â  Â  };

      // FIX: Added the missing downloadNotes function
      const downloadNotes = () => {
        const text = notesArea.value;
        const filename = 'DnD_Session_Notes_' + new Date().toISOString().slice(0, 10) + '.md';

        // Create a Blob containing the text content as Markdown
        const blob = new Blob([text], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        // Create a temporary anchor element to trigger the download
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;

        // Trigger the download and clean up
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

Â  Â  Â  const handleClear = () => {
Â  Â  Â  Â  const modalId = 'clear-modal';
Â  Â  Â  Â  let modal = document.getElementById(modalId);
Â  Â  Â  Â  if (!modal) {
Â  Â  Â  Â  Â  Â  modal = document.createElement('div');
Â  Â  Â  Â  Â  Â  modal.id = modalId;
Â  Â  Â  Â  Â  Â  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
Â  Â  Â  Â  Â  Â  modal.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-content-bg bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform transition-transform duration-300 scale-95">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold mb-4 text-red-600">Confirm Clear</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mb-6 text-slate-700 dark-mode:text-slate-300">Are you sure you want to delete ALL session notes? This action cannot be undone.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="cancel-clear" class="px-4 py-2 text-sm bg-slate-300 dark-mode:bg-[#444] rounded hover:bg-slate-400 dark-mode:hover:bg-[#555]">Cancel</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="confirm-clear" class="px-4 py-2 text-sm bg-red-600 text-white rounded hover:bg-red-700">Yes, Clear All</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  document.body.appendChild(modal);

Â  Â  Â  Â  Â  Â  document.getElementById('cancel-clear').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.remove('opacity-100', 'pointer-events-auto');
Â  Â  Â  Â  Â  Â  Â  Â  modal.querySelector('div').classList.remove('scale-100');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById('confirm-clear').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.remove('opacity-100', 'pointer-events-auto');
Â  Â  Â  Â  Â  Â  Â  Â  modal.querySelector('div').classList.remove('scale-100');
Â  Â  Â  Â  Â  Â  Â  Â  // Execute the clear logic
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem(STORAGE_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  notesArea.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  saveNotes();
Â  Â  Â  Â  Â  Â  Â  Â  updateWordCount();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // Apply dark mode classes to modal if needed before showing
Â  Â  Â  Â  const isDark = document.body.classList.contains('dark-mode');
Â  Â  Â  Â  const modalContent = modal.querySelector('.modal-content-bg');
Â  Â  Â  Â  if (isDark) {
Â  Â  Â  Â  Â  modalContent.classList.add('dark-mode');
          modalContent.classList.remove('bg-white');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  modalContent.classList.remove('dark-mode');
          modalContent.classList.add('bg-white');
Â  Â  Â  Â  }

Â  Â  Â  Â  // Show the modal
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  modal.classList.add('opacity-100', 'pointer-events-auto');
Â  Â  Â  Â  Â  Â  modal.querySelector('div').classList.add('scale-100');
Â  Â  Â  Â  }, 10);
Â  Â  Â  };
      
Â  Â  Â  const insertAtCursor = (before, after = before) => {
Â  Â  Â  Â  const start = notesArea.selectionStart;
Â  Â  Â  Â  const end = notesArea.selectionEnd;
Â  Â  Â  Â  const text = notesArea.value;
Â  Â  Â  Â  const selected = text.substring(start, end);

        // Check if the selected text already contains the formatting (for toggling)
        if (before === after && selected.startsWith(before) && selected.endsWith(after) && selected.length >= before.length * 2) {
            const strippedSelected = selected.substring(before.length, selected.length - after.length);
            notesArea.value = text.substring(0, start) + strippedSelected + text.substring(end);
            notesArea.selectionStart = start;
            notesArea.selectionEnd = start + strippedSelected.length;
        } else {
            notesArea.value = text.substring(0, start) + before + selected + after + text.substring(end);
            notesArea.selectionStart = start + before.length;
            notesArea.selectionEnd = end + before.length;
        }
        
Â  Â  Â  Â  notesArea.focus();
Â  Â  Â  Â  saveNotes();
Â  Â  Â  Â  updateWordCount();
Â  Â  Â  };

      // --- Dark Mode Logic ---

Â  Â  Â  const updateDarkToggleIcon = (isDark) => {
Â  Â  Â  Â  // Now only showing the icon on mobile, using span to hide the text
Â  Â  Â  Â  darkToggle.innerHTML = isDark 
Â  Â  Â  Â  Â  ? 'â˜€ï¸ <span class="hidden sm:inline">Light Mode</span>' 
Â  Â  Â  Â  Â  : 'ğŸŒ™ <span class="hidden sm:inline">Dark Mode</span>';
Â  Â  Â  };

Â  Â  Â  const toggleDark = () => {
Â  Â  Â  Â  document.body.classList.toggle('dark-mode');
Â  Â  Â  Â  const isDark = document.body.classList.contains('dark-mode');
Â  Â  Â  Â  localStorage.setItem(DARK_KEY, isDark ? '1' : '0');
Â  Â  Â  Â  updateDarkToggleIcon(isDark);
Â  Â  Â  };

Â  Â  Â  const applyDarkPreference = () => {
Â  Â  Â  Â  const isDark = localStorage.getItem(DARK_KEY) === '1';
Â  Â  Â  Â  if (isDark) {
Â  Â  Â  Â  Â  document.body.classList.add('dark-mode');
Â  Â  Â  Â  }
Â  Â  Â  Â  updateDarkToggleIcon(isDark);
Â  Â  Â  };

      // --- Index, Tag Generation & Clickable Jumps ---

      const generateIndexAndRender = () => {
        const text = notesArea.value;
        
        // 1. Tag Extraction: Look for @Word (no spaces)
        const tagRegex = /@(\w+)/g;
        const rawTags = [...text.matchAll(tagRegex)].map(match => match[1]);
        const uniqueTags = [...new Set(rawTags)].sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

        // Map to store tags and their IDs for linking
        const tagMap = new Map();
        uniqueTags.forEach(tag => {
            // Create a unique, URL-safe ID
            tagMap.set(tag, `tag-${tag.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`);
        });

        let tagHtml = '<div><h4 class="text-lg font-semibold mt-4 mb-2 border-b pb-1 border-slate-300 dark-mode:border-gray-600">Detected Tags (@)</h4>';
        if (uniqueTags.length === 0) {
            tagHtml += '<p class="text-sm italic text-gray-500 dark-mode:text-gray-400">No tags detected.</p></div>';
        } else {
            tagHtml += '<div class="flex flex-wrap gap-2 pt-2">';
            tagMap.forEach((id, tag) => {
                // Make the tag clickable in the index panel using the generated ID
                tagHtml += `
                    <a href="#${id}" class="inline-block bg-indigo-100 text-indigo-800 dark-mode:bg-indigo-900 dark-mode:text-indigo-200 px-2 py-0.5 rounded-full text-xs font-medium hover:bg-indigo-200 dark-mode:hover:bg-indigo-800 transition">
                        @${tag}
                    </a>
                `;
            });
            tagHtml += '</div></div>';
        }

        // 2. Header Extraction (Simple TOC)
        const headerRegex = /^(#+)\s(.+)$/gm;
        let headers = [];
        text.replace(headerRegex, (match, levelStr, title) => {
            const level = levelStr.length;
            headers.push({ level, title });
            return match; 
        });


        let tocHtml = '<div><h4 class="text-lg font-semibold mb-2 border-b pb-1 border-slate-300 dark-mode:border-gray-600">Table of Contents</h4>';
        if (headers.length === 0) {
            tocHtml += '<p class="text-sm italic text-gray-500 dark-mode:text-gray-400">No headings detected.</p></div>';
        } else {
            tocHtml += '<ul class="list-none p-0 space-y-1 pt-2">';
            headers.forEach(h => {
                const indent = (h.level - 1) * 1; 
                tocHtml += `<li style="padding-left: ${indent}rem;" class="text-sm text-slate-700 dark-mode:text-slate-300 overflow-hidden text-ellipsis whitespace-nowrap">${h.title}</li>`;
            });
            tocHtml += '</ul></div>';
        }

        // 3. Render Markdown
        let renderedHtml = md.render(notesArea.value);
        
        // 4. Post-Process HTML to Add Jump-To Targets (Only to the FIRST mention of each tag)
        tagMap.forEach((id, tag) => {
            const tagWithAt = `@${tag}`;
            // The target span uses the ID and highlights the tag.
            // Using a slightly stronger background here for visibility
            const targetSpan = `<span id="${id}" class="scroll-target font-bold bg-yellow-200 text-yellow-900 dark-mode:bg-yellow-700/50 p-0.5 rounded">${tagWithAt}</span>`;

            // Find the first index of the raw tag string in the rendered HTML
            const firstIndex = renderedHtml.indexOf(tagWithAt);
            
            if (firstIndex !== -1) {
                // Replace ONLY the first instance with the target span
                renderedHtml = renderedHtml.substring(0, firstIndex) + 
                               targetSpan + 
                               renderedHtml.substring(firstIndex + tagWithAt.length);
            }
        });

        // 5. Combine Index Panel and Rendered HTML
        const indexPanel = `
            <div class="mb-8 p-4 rounded-xl index-panel shadow-inner">
                ${tocHtml}
                <hr class="my-4 border-slate-200 dark-mode:border-gray-700"/>
                ${tagHtml}
            </div>
        `;

        preview.innerHTML = indexPanel + renderedHtml;
    };


Â  Â  Â  // --- Event Handlers and Helpers ---
      
Â  Â  Â  const handleKeyDown = (e) => {
Â  Â  Â  Â  if (!(e.ctrlKey || e.metaKey)) return; 

Â  Â  Â  Â  switch (e.key.toLowerCase()) {
Â  Â  Â  Â  Â  case 'b': e.preventDefault(); insertAtCursor('**'); break;
Â  Â  Â  Â  Â  case 'i': e.preventDefault(); insertAtCursor('*'); break;
Â  Â  Â  Â  Â  case 't': e.preventDefault(); insertTimestamp(); break;
Â  Â  Â  Â  Â  case 'p': e.preventDefault(); togglePreview(); break;
Â  Â  Â  Â  Â  case 's': e.preventDefault(); saveNotes(); break;
Â  Â  Â  Â  }
Â  Â  Â  };


Â  Â  Â  const insertTimestamp = () => {
Â  Â  Â  Â  const now = new Date().toLocaleString();
Â  Â  Â  Â  insertAtCursor(`\n**[${now}]**\n`);
Â  Â  Â  };

Â  Â  Â  const togglePreview = () => {
Â  Â  Â  Â  if (preview.classList.contains('hidden')) {
Â  Â  Â  Â  Â  // Show Preview
Â  Â  Â  Â  Â  generateIndexAndRender(); // Generate and render content with index/tags
Â  Â  Â  Â  Â  notesArea.classList.add('hidden');
Â  Â  Â  Â  Â  preview.classList.remove('hidden');
Â  Â  Â  Â  Â  previewToggle.innerHTML = 'âœï¸ <span class="hidden sm:inline">Edit</span>';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Show Editor
Â  Â  Â  Â  Â  preview.classList.add('hidden');
Â  Â  Â  Â  Â  notesArea.classList.remove('hidden');
Â  Â  Â  Â  Â  previewToggle.innerHTML = 'ğŸ‘ï¸ <span class="hidden sm:inline">Preview</span>';
          notesArea.focus(); // Return focus to the editor
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  const updateWordCount = () => {
Â  Â  Â  Â  const text = notesArea.value.trim();
Â  Â  Â  Â  const words = text ? text.split(/\s+/).filter(w => w.length > 0).length : 0;
Â  Â  Â  Â  const chars = text.length;
Â  Â  Â  Â  wordCount.textContent = `${words} words â€¢ ${chars} chars`;
Â  Â  Â  };
      
      // Initialize Event Listeners
Â  Â  Â  toolbarBtns.forEach(btn => btn.addEventListener('click', () => {
Â  Â  Â  Â  const f = btn.dataset.format;
Â  Â  Â  Â  switch(f) {
Â  Â  Â  Â  Â  case 'bold': insertAtCursor('**'); break;
Â  Â  Â  Â  Â  case 'italic': insertAtCursor('*'); break;
Â  Â  Â  Â  Â  case 'underline': insertAtCursor('<u>', '</u>'); break;
Â  Â  Â  Â  Â  case 'strike': insertAtCursor('~~'); break;
Â  Â  Â  Â  Â  case 'list': insertAtCursor('- ', ''); break;
Â  Â  Â  Â  Â  case 'quote': insertAtCursor('> ', ''); break;
Â  Â  Â  Â  Â  case 'code': insertAtCursor('`'); break;
Â  Â  Â  Â  Â  case 'divider': insertAtCursor('\n---\n', ''); break;
Â  Â  Â  Â  }
Â  Â  Â  }));

Â  Â  Â  headingSelect.addEventListener('change', () => {
Â  Â  Â  Â  const val = headingSelect.value;
Â  Â  Â  Â  if (!val) return;
Â  Â  Â  Â  const prefix = val === 'h1' ? '# ' : val === 'h2' ? '## ' : '### ';
Â  Â  Â  Â  insertAtCursor('\n' + prefix, '\n');
Â  Â  Â  Â  headingSelect.value = '';
Â  Â  Â  });

Â  Â  Â  notesArea.addEventListener('input', () => {
Â  Â  Â  Â  saveNotes();
Â  Â  Â  Â  updateWordCount();
Â  Â  Â  });

Â  Â  Â  saveBtn.addEventListener('click', saveNotes);
Â  Â  Â  clearBtn.addEventListener('click', handleClear);
Â  Â  Â  downloadBtn.addEventListener('click', downloadNotes);
Â  Â  Â  timestampBtn.addEventListener('click', insertTimestamp);
Â  Â  Â  previewToggle.addEventListener('click', togglePreview);
Â  Â  Â  darkToggle.addEventListener('click', toggleDark);

Â  Â  Â  // Register global key listener
Â  Â  Â  document.addEventListener('keydown', handleKeyDown);

Â  Â  Â  loadNotes();
Â  Â  Â  applyDarkPreference();
Â  Â  });
Â  </script>
</body>
</html>
